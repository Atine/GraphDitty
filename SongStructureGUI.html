<html>
<head>
    <script src="jslibs/d3.min.js"></script>
    <script src="UtilityFunctions.js"></script>
    <script src="StructureCanvas.js"></script>
    <script src="ForceCanvas.js"></script>
    <link rel="stylesheet" href="styles.css">
    </head>
<body>

<h1>Song Structure GUI</h1>
<h2>by Chris Tralie</h2>

<h3>Directions</h3>
<ul>
<li>Load in a JSON file generated by SongStructure.py.  The similarity matrix is shown up top, and the Laplacian eigenvectors are shown on the bottom</li>
<li>Click Play/Pause to Play/Pause the audio</li>
<li>Left click on the similarity matrix to jump the song to the row index of the selected point</li>
<li>Right click on the similarity matrix to jump to the column index of the selected point</li>
<li>Left or right click on the Laplacian eigenvectors to jump to the corresponding place in the audio</li>
</ul>

<HR>
<table>
<tr><td><h3>File Input</h3></td><td><input type = "file" id = "fileInput"></td><td colspan = "2"></td></tr>
</table>

<table>
<tr>
    <td><audio id="audio_widget" controls></audio></td>
</tr>

<tr>
    <td><h3><p id = "songname"></p></h3></td>
</tr>

<tr>
    <td>
        <div class="tabmenu">
            
        </div>
                  
    </td>
</tr>

<tr>
    <td>
        <div id="SSMCanvas">
            <svg id="SimilarityCanvas" width="800" height="700"></svg><BR>
            <svg id="EigCanvas" width="800" height="10"></svg>
        </div>

        <div id="ForceCanvas">
            
        </div>
    </td>
</tr>

<tr><td></td>
    <h3><p id = "pagestatus"><font color = "yellow">Waiting for user input...</font></p></h3>
</td></tr>
</table>

<script>
    //https://www.w3schools.com/tags/ref_av_dom.asp
    var audio_obj = {'audio_widget':document.getElementById("audio_widget"), 
                                'time_interval':0, 'dim':0};
    audio_obj.audio_widget.style.width = 800;
    var waitingDisp = document.getElementById("pagestatus");
    var songnameTxt = document.getElementById("songname");

    // Step 2: Initialize canvases
    var stcanvas = new StructureCanvas(audio_obj);
    var fcanvas = new ForceCanvas(audio_obj);

    // Step 3: Setup Tabs
    changeTab = function(tab, i) {
        d3.select('.tabmenu').selectAll('button')
          .attr("class", function(d) {
            /* Change display style of active tab relative to others */
            if (d == tab) {
                return "active";
            }
            return "";
          })
          .each(function(d) {
            /* Hide inactive tabs */
            if (d == tab) {
                d.canvas.show()
            }
            else {
                d.canvas.hide();
            }
          });
    };
    var data = [{name:"Self-Similarity", canvas:stcanvas}, 
            {name:"Force Graph", canvas:fcanvas}];
    d3.select('.tabmenu').selectAll("button")
					   .data(data)
                       .enter().append("button").on('click', changeTab)
                       .text(function (d) {return d.name});


    var fileInput = document.getElementById('fileInput');
	fileInput.addEventListener('change', function(e) {
		var file = fileInput.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
            var params = JSON.parse(reader.result);
            //Setup audio buffers
            audio_obj.audio_widget.src = params.audio;
            audio_obj.time_interval = params.time_interval;
            audio_obj.dim = params.dim;
            songnameTxt.innerHTML = params.songname;
            stcanvas.updateParams(params);
            fcanvas.updateParams(params);
            
            changeToReady();
		}
		reader.readAsText(file);
    });
    
    refreshDisplays = function() {
        requestAnimationFrame(stcanvas.repaint.bind(stcanvas));
    }
    audio_obj.audio_widget.addEventListener("play", refreshDisplays);
    audio_obj.audio_widget.addEventListener("pause", refreshDisplays);
</script>


</body>
</html>
